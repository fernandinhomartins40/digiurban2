name: ğŸš€ Deploy DigiUrban

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if no changes'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  SERVICE_NAME: 'digiurban.service'
  DEPLOY_PATH: '/opt/digiurban'

jobs:
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: ğŸ”§ Install Dependencies
      run: npm ci --silent

    - name: ğŸ—ï¸ Build Frontend
      run: |
        npm run build
        echo "âœ… Frontend build completed"

    - name: ğŸ§ª Test Backend Startup
      env:
        NODE_ENV: test
        JWT_SECRET: test-secret-for-build
        DATABASE_URL: postgres://test:test@localhost:5432/test
      run: |
        echo "Testing backend startup..."
        timeout 10s npm run start || echo "âœ… Backend startup test completed"

    - name: ğŸ“Š Build Summary
      run: |
        echo "## ğŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Frontend build: $(du -sh dist | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Backend size: $(du -sh src/server | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ Dependencies: $(ls node_modules | wc -l) packages" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ğŸš€ Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup deployment variables
      run: |
        echo "TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
        echo "COMMIT_HASH=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

    - name: ğŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 600s
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Install system dependencies
          echo "ğŸ“¦ Installing system dependencies..."
          apt update -y
          apt install -y curl git wget unzip postgresql-client
          
          # Install Node.js 18 if not exists
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¦ Installing Node.js 18..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt install -y nodejs
          fi
          
          # Verify Node.js installation
          echo "âœ… Node.js version: $(node --version)"
          echo "âœ… NPM version: $(npm --version)"
          
          # Create directories
          mkdir -p ${{ env.DEPLOY_PATH }}
          cd ${{ env.DEPLOY_PATH }}
          
          # Backup current deployment
          if [ -d "current" ]; then
            echo "ğŸ“¦ Creating backup..."
            cp -r current backup_$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            # Keep only last 3 backups
            ls -dt backup_* | tail -n +4 | xargs rm -rf 2>/dev/null || true
          fi
          
          # Clone repository
          echo "ğŸ“¥ Cloning repository..."
          rm -rf digiurban2
          
          # Configure Git for non-interactive clone
          git config --global user.email "deploy@digiurban.com"
          git config --global user.name "Deploy Bot"
          git config --global init.defaultBranch main
          
          # Use wget method first (more reliable for public repos)
          echo "ğŸ“¥ Downloading repository..."
          
          # Download repository using GitHub token for private repos
          if wget --header="Authorization: token ${{ secrets.GITHUB_TOKEN }}" -O main.zip "https://github.com/fernandinhomartins040/digiurban2/archive/main.zip"; then
            echo "âœ… Downloaded main.zip with authentication"
          elif wget --header="Authorization: token ${{ secrets.GITHUB_TOKEN }}" -O main.zip "https://github.com/fernandinhomartins040/digiurban2/archive/refs/heads/main.zip"; then
            echo "âœ… Downloaded main.zip (alternative URL) with authentication"
          else
            echo "âŒ Wget failed, trying git clone with token..."
            # Remove any failed download files
            rm -f main.zip
            
            # Fallback to git clone with authentication
            if git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/fernandinhomartins040/digiurban2.git; then
              echo "âœ… Git clone successful with authentication"
            else
              echo "âŒ All download methods failed"
              exit 1
            fi
          fi
          
          # If we have a zip file, extract it
          if [ -f "main.zip" ]; then
            echo "ğŸ“¦ Extracting archive..."
            if unzip -q main.zip; then
              # Find the extracted directory (could be digiurban2-main or fernandinhomartins040-digiurban2-*)
              EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "*digiurban2*" ! -name "digiurban2" | head -1)
              if [ -n "$EXTRACTED_DIR" ]; then
                mv "$EXTRACTED_DIR" digiurban2
                echo "âœ… Archive extracted and renamed to digiurban2"
              else
                echo "âŒ Could not find extracted directory"
                ls -la
                exit 1
              fi
              rm main.zip
            else
              echo "âŒ Failed to extract archive"
              exit 1
            fi
          fi
          
          if [ ! -d "digiurban2" ]; then
            echo "âŒ Repository directory not found after clone"
            exit 1
          fi
          
          cd digiurban2
          echo "âœ… Repository cloned successfully"
          
          # Install dependencies and build
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --silent
          
          # Install TypeScript if not present
          if ! command -v tsc &> /dev/null; then
            echo "ğŸ“¦ Installing TypeScript globally..."
            npm install -g typescript
          fi
          
          echo "ğŸ—ï¸ Building application..."
          npm run build
          
          # Verify that server files were built
          echo "ğŸ” Verifying server build..."
          if [ ! -f "dist-server/server/index.js" ]; then
            echo "âŒ Server build failed - index.js not found"
            echo "ğŸ“ Contents of dist-server/:"
            ls -la dist-server/ || echo "dist-server directory not found"
            echo "ğŸ“ Contents of dist-server/server/:"
            ls -la dist-server/server/ || echo "dist-server/server directory not found"
            exit 1
          fi
          echo "âœ… Server build verified"
          
          # Verify frontend build
          if [ ! -d "dist" ]; then
            echo "âŒ Frontend build failed - dist directory not found"
            exit 1
          fi
          
          # Copy frontend build to backend public
          echo "ğŸ“‚ Copying frontend build to backend..."
          mkdir -p dist-server/public
          cp -r dist/* dist-server/public/
          
          # Update current symlink
          cd ${{ env.DEPLOY_PATH }}
          rm -f current
          ln -sf digiurban2 current
          
          # Setup environment
          cd current
          if [ ! -f .env ]; then
            echo "âš™ï¸ Creating environment file..."
            cat > .env << EOF
          NODE_ENV=production
          PORT=3003
          DATABASE_URL=postgres://digiurban:${{ secrets.DB_PASSWORD || 'postgres' }}@localhost:5432/digiurban_db
          JWT_SECRET=${{ secrets.JWT_SECRET || 'change-this-secret-in-production' }}
          CORS_ORIGIN=https://www.digiurban.com.br
          EOF
          fi
          
          # Setup PostgreSQL database if needed
          echo "ğŸ—„ï¸ Setting up database..."
          
          # Install PostgreSQL if not present
          if ! command -v psql &> /dev/null; then
            echo "ğŸ“¦ Installing PostgreSQL..."
            apt install -y postgresql postgresql-contrib
            systemctl start postgresql
            systemctl enable postgresql
          fi
          
          # Ensure PostgreSQL is running
          systemctl status postgresql || systemctl start postgresql
          
          # Create database and user if they don't exist
          if ! sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw digiurban_db; then
            echo "ğŸ—ï¸ Creating database and user..."
            sudo -u postgres createdb digiurban_db
            sudo -u postgres psql -c "CREATE USER digiurban WITH PASSWORD '${{ secrets.DB_PASSWORD || 'postgres' }}';" || echo "User may already exist"
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE digiurban_db TO digiurban;"
            sudo -u postgres psql -c "ALTER USER digiurban CREATEDB;"
          fi
          
          # Test database connection
          echo "ğŸ§ª Testing database connection..."
          export DATABASE_URL="postgres://digiurban:${{ secrets.DB_PASSWORD || 'postgres' }}@localhost:5432/digiurban_db"
          
          # Skip migration as it will run automatically when the server starts
          echo "âœ… Database setup completed"
          
          # Create digiurban user if not exists
          if ! id "digiurban" &>/dev/null; then
            echo "ğŸ‘¤ Creating digiurban user..."
            useradd -r -s /bin/bash -d /opt/digiurban -c "DigiUrban Application" digiurban
          fi
          
          # Setup systemd service
          echo "âš™ï¸ Setting up systemd service..."
          
          # Create logs directory
          mkdir -p /opt/digiurban/logs
          
          # Copy systemd service file
          cp /opt/digiurban/current/systemd/digiurban.service /etc/systemd/system/
          
          # Set proper permissions
          chown -R digiurban:digiurban /opt/digiurban
          chmod -R 755 /opt/digiurban
          
          # Reload systemd and enable service
          systemctl daemon-reload
          systemctl enable digiurban.service
          
          # Stop service if running
          systemctl stop digiurban.service 2>/dev/null || true
          
          # Start service
          echo "ğŸš€ Starting DigiUrban service..."
          systemctl start digiurban.service
          
          # Wait a moment for service to initialize
          sleep 10
          
          # Show systemd status
          echo "ğŸ“Š Systemd Status:"
          systemctl status digiurban.service --no-pager -l || true
          
          echo "âœ… Deployment completed!"
          
          # Health check
          echo "ğŸ” Running health check..."
          echo "â° Waiting 20 seconds for application to start..."
          sleep 20
          
          # Check if systemd service is running
          echo "ğŸ“Š Systemd Status:"
          systemctl status digiurban.service --no-pager -l || echo "Service not found"
          
          # Check if port 3003 is listening
          echo "ğŸ”Œ Checking port 3003:"
          netstat -tlnp | grep :3003 || echo "Port 3003 not listening"
          
          # Try health check multiple times
          echo "ğŸ©º Attempting health check..."
          for i in {1..5}; do
            echo "Attempt $i/5..."
            if curl -f http://localhost:3003/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              break
            else
              echo "âŒ Health check failed (attempt $i)"
              if [ $i -eq 5 ]; then
                echo "ğŸ” Final attempt failed. Showing logs and details:"
                echo "===== SYSTEMD STATUS ====="
                systemctl status digiurban.service --no-pager -l
                echo "===== SYSTEMD LOGS ====="
                journalctl -u digiurban.service --no-pager -l -n 50
                echo "===== APPLICATION LOGS ====="
                cat /opt/digiurban/logs/digiurban.log 2>/dev/null || echo "No application log file"
                echo "===== ERROR LOGS ====="
                cat /opt/digiurban/logs/digiurban-error.log 2>/dev/null || echo "No error log file"
                echo "===== NETWORK CONNECTIONS ====="
                netstat -tlnp | grep :3003 || echo "Port 3003 not listening"
                echo "===== DATABASE STATUS ====="
                systemctl status postgresql --no-pager
                echo "===== PROCESS LIST ====="
                ps aux | grep -E "(node|digiurban)" | grep -v grep
                echo "===== ENVIRONMENT ====="
                env | grep -E "(NODE|PORT|DATABASE)"
                echo "âŒ Health check failed after 5 attempts"
                exit 1
              fi
              sleep 10
            fi
          done

    - name: ğŸ” Verify Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "ğŸ” Deployment verification..."
          
          # Check systemd status
          echo "ğŸ“Š Systemd Status:"
          systemctl status digiurban.service --no-pager -l
          
          # Check application logs
          echo "ğŸ“‹ Recent logs:"
          journalctl -u digiurban.service --no-pager -l -n 10
          
          # Test endpoints
          echo "ğŸŒ Testing endpoints..."
          curl -s http://localhost:3003/api/health | jq '.' 2>/dev/null || echo "Health endpoint OK"
          curl -s http://localhost:3003/ | head -5 || echo "Root endpoint OK"
          
          echo "âœ… Verification completed!"

    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Server:** ${{ secrets.VPS_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ env.COMMIT_HASH }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL:** https://www.digiurban.com.br" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸŒ Website](https://www.digiurban.com.br)" >> $GITHUB_STEP_SUMMARY
        echo "- [â¤ï¸ Health Check](http://${{ secrets.VPS_HOST }}:3003/api/health)" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“Š API Status](http://${{ secrets.VPS_HOST }}:3003/)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ğŸ“¢ Notify Results
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "âœ… Application is live at https://www.digiurban.com.br"
        
    - name: ğŸš¨ Failure Notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        echo "Check the logs above for details."
        exit 1 