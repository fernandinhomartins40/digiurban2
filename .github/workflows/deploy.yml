name: ğŸš€ Deploy DigiUrban2 React App (Docker)

# Controle de concorrÃªncia - ÃšNICO deploy por vez
concurrency:
  group: digiurban2-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package*.json'
      - 'Dockerfile'
      - 'nginx.conf'
      - '.dockerignore'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  VPS_HOST: '31.97.85.98'
  VPS_USER: 'root'
  APP_DIR: '/root/digiurban2'
  APP_PORT: '3003'
  IMAGE_NAME: 'digiurban2-react'

jobs:
  analyze-changes:
    name: ğŸ” Analisar MudanÃ§as
    runs-on: ubuntu-latest
    outputs:
      has_code_changes: ${{ steps.changes.outputs.has_code_changes }}
      has_package_changes: ${{ steps.changes.outputs.has_package_changes }}
      has_config_changes: ${{ steps.changes.outputs.has_config_changes }}
      needs_restart: ${{ steps.changes.outputs.needs_restart }}
      deploy_type: ${{ steps.changes.outputs.deploy_type }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: ğŸ” Analisar arquivos alterados
      id: changes
      run: |
        echo "ğŸ” Analisando mudanÃ§as desde o Ãºltimo commit..."
        
        # Obter arquivos alterados
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "all")
        echo "ğŸ“ Arquivos alterados:"
        echo "$CHANGED_FILES"
        
        # Inicializar flags
        HAS_CODE=false
        HAS_PACKAGE=false
        HAS_CONFIG=false
        NEEDS_RESTART=false
        
        # Analisar tipos de mudanÃ§as para DigiUrban2 React App
        if echo "$CHANGED_FILES" | grep -E "(src/.*\.(js|ts|tsx|jsx|json)|vite\.config\.(js|ts)|index\.html|Dockerfile|nginx\.conf)" > /dev/null; then
          HAS_CODE=true
          echo "âœ… MudanÃ§as de cÃ³digo frontend detectadas"
        fi
        
        if echo "$CHANGED_FILES" | grep -E "package(-lock)?\.json" > /dev/null; then
          HAS_PACKAGE=true
          echo "ğŸ“¦ MudanÃ§as em dependÃªncias detectadas"
        fi
        
        if echo "$CHANGED_FILES" | grep -E "(\.env|vite\.config\.(js|ts)|tailwind\.config\.(js|ts)|Dockerfile|\.dockerignore|nginx\.conf)" > /dev/null; then
          HAS_CONFIG=true
          echo "âš™ï¸ MudanÃ§as de configuraÃ§Ã£o detectadas"
        fi
        
        # Determinar se precisa restart
        if [[ "$HAS_CODE" == "true" || "$HAS_CONFIG" == "true" ]]; then
          NEEDS_RESTART=true
        fi
        
        # Determinar tipo de deploy
        if [[ "$HAS_PACKAGE" == "true" ]]; then
          DEPLOY_TYPE="full"
          echo "ğŸ”„ Deploy completo necessÃ¡rio (dependÃªncias mudaram)"
        elif [[ "$HAS_CODE" == "true" ]]; then
          DEPLOY_TYPE="code-only"
          echo "ğŸ“ Deploy apenas de cÃ³digo"
        elif [[ "$HAS_CONFIG" == "true" ]]; then
          DEPLOY_TYPE="config-only"
          echo "âš™ï¸ Deploy apenas de configuraÃ§Ã£o"
        else
          DEPLOY_TYPE="minimal"
          echo "ğŸ“‹ Deploy mÃ­nimo (docs/workflows)"
        fi
        
        # Definir outputs
        echo "has_code_changes=$HAS_CODE" >> $GITHUB_OUTPUT
        echo "has_package_changes=$HAS_PACKAGE" >> $GITHUB_OUTPUT
        echo "has_config_changes=$HAS_CONFIG" >> $GITHUB_OUTPUT
        echo "needs_restart=$NEEDS_RESTART" >> $GITHUB_OUTPUT
        echo "deploy_type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT

  deploy:
    name: ğŸš€ Deploy Docker
    runs-on: ubuntu-latest
    needs: analyze-changes
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“‹ Info do Deploy Docker
      run: |
        echo "ğŸš€ Deploy DigiUrban2 React App com Docker"
        echo "=============================================="
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Tipo de Deploy: ${{ needs.analyze-changes.outputs.deploy_type }}"
        echo "MudanÃ§as de CÃ³digo: ${{ needs.analyze-changes.outputs.has_code_changes }}"
        echo "MudanÃ§as de DependÃªncias: ${{ needs.analyze-changes.outputs.has_package_changes }}"
        echo "Precisa Restart: ${{ needs.analyze-changes.outputs.needs_restart }}"
        echo "=============================================="

    - name: ğŸ”‘ Configurar SSH
      run: |
        echo "ğŸ”‘ Configurando SSH para deploy..."
        mkdir -p ~/.ssh
        
        # Escrever a chave SSH de forma segura
        echo "${{ secrets.VPS_PASSWORD }}" | tr -d '\r' > ~/.ssh/id_rsa
        
        # Verificar se a chave foi escrita corretamente
        if [ ! -s ~/.ssh/id_rsa ]; then
          echo "âŒ Erro: Chave SSH vazia ou nÃ£o encontrada"
          exit 1
        fi
        
        # Definir permissÃµes corretas
        chmod 600 ~/.ssh/id_rsa
        chmod 700 ~/.ssh
        
        # Verificar formato da chave
        if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
          echo "âŒ Erro: Formato de chave SSH invÃ¡lido"
          head -2 ~/.ssh/id_rsa
          exit 1
        fi
        
        # Adicionar host conhecido
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts
        
        # Testar conexÃ£o SSH
        echo "ğŸ” Testando conexÃ£o SSH..."
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'ConexÃ£o SSH bem-sucedida'"
        
        echo "âœ… SSH configurado e testado"

    - name: ğŸ” Verificar estado atual da VPS
      run: |
        echo "ğŸ” Verificando estado atual..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo '=== Estado Atual da VPS ==='
          echo 'Docker version:'
          docker --version || echo 'Docker nÃ£o encontrado'
          
          echo ''
          echo 'Docker Containers:'
          docker ps --format 'table {{.Names}}\t{{.Status}}' | grep ${{ env.IMAGE_NAME }} || echo 'Container nÃ£o rodando'
          
          echo ''
          echo 'Ãšltima atualizaÃ§Ã£o:'
          cd ${{ env.APP_DIR }} && git log --oneline -1 2>/dev/null || echo 'RepositÃ³rio nÃ£o inicializado'
        "

    - name: ğŸš€ Deploy usando Docker
      run: |
        echo "ğŸš€ Executando deploy com Docker..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Garantir que o diretÃ³rio existe
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Clonar ou atualizar o repositÃ³rio
          if [ ! -d .git ]; then
            echo 'ğŸ†• Clonando repositÃ³rio...'
            git clone https://github.com/${{ github.repository }}.git .
          else
            echo 'ğŸ“¥ Atualizando repositÃ³rio...'
            git fetch origin
            git reset --hard origin/main
          fi
          
          # Deploy DigiUrban2 React App usando Docker
          echo 'ğŸš€ Executando deploy DigiUrban2 React App com Docker...'
          
          # Parar e remover container anterior se existir
          echo 'ğŸ”„ Parando container anterior...'
          docker stop ${{ env.IMAGE_NAME }} 2>/dev/null || true
          docker rm ${{ env.IMAGE_NAME }} 2>/dev/null || true
          
          # Limpar imagem anterior se mudanÃ§as significativas
          if [[ '${{ needs.analyze-changes.outputs.has_package_changes }}' == 'true' ]]; then
            echo 'ğŸ§¹ Limpando imagem anterior (dependÃªncias mudaram)...'
            docker rmi ${{ env.IMAGE_NAME }}:latest 2>/dev/null || true
          fi
          
          # Build da imagem Docker
          echo 'ğŸ—ï¸ Building Docker image...'
          docker build -t ${{ env.IMAGE_NAME }}:latest .
          
          # Verificar se a imagem foi criada
          if ! docker images | grep -q ${{ env.IMAGE_NAME }}; then
            echo 'âŒ Falha ao criar imagem Docker!'
            exit 1
          fi
          
          echo 'âœ… Imagem Docker criada com sucesso'
          
          # Iniciar container na porta especificada
          echo 'ğŸš€ Iniciando container na porta ${{ env.APP_PORT }}...'
          docker run -d \
            --name ${{ env.IMAGE_NAME }} \
            -p ${{ env.APP_PORT }}:80 \
            --restart unless-stopped \
            ${{ env.IMAGE_NAME }}:latest
          
          # Aguardar container inicializar
          echo 'â³ Aguardando container inicializar...'
          sleep 15
          
          # Verificar se container estÃ¡ rodando
          if ! docker ps | grep -q ${{ env.IMAGE_NAME }}; then
            echo 'âŒ Container nÃ£o estÃ¡ rodando!'
            echo 'ğŸ“‹ Status do container:'
            docker ps -a | grep ${{ env.IMAGE_NAME }} || echo 'Container nÃ£o encontrado'
            echo 'ğŸ“‹ Logs do container:'
            docker logs ${{ env.IMAGE_NAME }} 2>/dev/null || echo 'Sem logs disponÃ­veis'
            exit 1
          fi
          
          # Verificar se estÃ¡ funcionando
          echo 'ğŸ” Testando React app...'
          for i in {1..5}; do
            if curl -f -s http://localhost:${{ env.APP_PORT }}/ >/dev/null 2>&1; then
              echo 'âœ… React app funcionando!'
              break
            else
              echo \"â³ Tentativa \$i/5...\"
              sleep 5
            fi
            
            if [ \$i -eq 5 ]; then
              echo 'âŒ React app nÃ£o respondeu apÃ³s 5 tentativas'
              echo 'ğŸ“‹ Logs do container:'
              docker logs ${{ env.IMAGE_NAME }}
              exit 1
            fi
          done
          
          echo 'âœ… DigiUrban2 React App deployed successfully on port ${{ env.APP_PORT }}'
          echo 'ğŸ“Š Status do container:'
          docker ps | grep ${{ env.IMAGE_NAME }}
          echo 'âœ… Deploy containerizado concluÃ­do'
        "

    - name: ğŸ” VerificaÃ§Ã£o Final
      run: |
        echo "ğŸ” VerificaÃ§Ã£o final..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.APP_DIR }}
          
          # Verificar status do container
          echo 'ğŸ” Status do container:'
          if docker ps | grep -q ${{ env.IMAGE_NAME }}; then
            echo 'âœ… Container rodando'
            docker ps | grep ${{ env.IMAGE_NAME }}
          else
            echo 'âŒ Container nÃ£o encontrado'
            exit 1
          fi
          
          # Verificar health check da aplicaÃ§Ã£o React
          echo 'ğŸ” Testando aplicaÃ§Ã£o React...'
          if curl -f -s http://localhost:${{ env.APP_PORT }}/ >/dev/null 2>&1; then
            echo 'âœ… AplicaÃ§Ã£o React respondendo'
          else
            echo 'âŒ AplicaÃ§Ã£o React nÃ£o estÃ¡ respondendo'
            docker logs ${{ env.IMAGE_NAME }} --tail 10
            exit 1
          fi
        "

    - name: ğŸ“Š RelatÃ³rio do Deploy
      if: always()
      run: |
        echo "ğŸ“Š RELATÃ“RIO DO DEPLOY DOCKER"
        echo "============================="
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo 'Tipo de Deploy: ${{ needs.analyze-changes.outputs.deploy_type }}'
          echo 'Restart Executado: ${{ needs.analyze-changes.outputs.needs_restart }}'
          echo 'DependÃªncias Atualizadas: ${{ needs.analyze-changes.outputs.has_package_changes }}'
          echo ''
          
          echo '=== Status do Container ==='
          if docker ps | grep -q ${{ env.IMAGE_NAME }}; then
            docker ps | grep ${{ env.IMAGE_NAME }}
          else
            echo 'âŒ Container nÃ£o encontrado'
          fi
          
          echo ''
          echo '=== Ãšltimo Commit ==='
          cd ${{ env.APP_DIR }} && git log --oneline -1
          
          echo ''
          echo 'ğŸ¯ AplicaÃ§Ã£o React: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}'
          echo 'âš¡ Deploy Docker DigiUrban2 concluÃ­do!'
        "

    - name: ğŸ‰ Deploy ConcluÃ­do
      run: |
        echo "ğŸ‰ DEPLOY DOCKER DIGIURBAN2 REALIZADO COM SUCESSO!"
        echo "âš¡ Tipo: ${{ needs.analyze-changes.outputs.deploy_type }}"
        echo "ğŸ³ Deploy isolado em container Docker"
        echo "ğŸš€ AplicaÃ§Ã£o React: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"