name: Deploy to Hostinger VPS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job de teste e build
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        
    - name: Run tests
      run: |
        npm run test --if-present
        
    - name: Build application
      run: |
        npm run build
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: dist/
        
  # Job de build da imagem Docker
  build-docker:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
  # Job de deploy completo no VPS
  deploy:
    needs: [build-and-test, build-docker]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup VPS and Deploy Application
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          set -e
          
          echo "ğŸš€ Iniciando deploy automatizado do DigiUrban..."
          
          # ========================================
          # 1. CONFIGURAÃ‡ÃƒO INICIAL DO AMBIENTE
          # ========================================
          
          # Criar usuÃ¡rio de deploy se nÃ£o existir
          if ! id "digiurban" &>/dev/null; then
            echo "ğŸ‘¤ Criando usuÃ¡rio digiurban..."
            sudo useradd -m -s /bin/bash digiurban
            sudo usermod -aG docker digiurban
            sudo usermod -aG sudo digiurban
          fi
          
          # Criar diretÃ³rio da aplicaÃ§Ã£o
          echo "ğŸ“ Criando estrutura de diretÃ³rios..."
          sudo mkdir -p /var/www/digiurban
          sudo chown -R digiurban:digiurban /var/www/digiurban
          
          # Navegar para o diretÃ³rio da aplicaÃ§Ã£o
          cd /var/www/digiurban
          
          # ========================================
          # 2. INSTALAÃ‡ÃƒO DE DEPENDÃŠNCIAS DO SISTEMA
          # ========================================
          
          echo "ğŸ“¦ Instalando dependÃªncias do sistema..."
          sudo apt-get update -y
          sudo apt-get install -y curl git nginx certbot python3-certbot-nginx fail2ban ufw
          
          # Instalar Docker se nÃ£o estiver instalado
          if ! command -v docker &> /dev/null; then
            echo "ğŸ³ Instalando Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          
          # Instalar Docker Compose se nÃ£o estiver instalado
          if ! command -v docker-compose &> /dev/null; then
            echo "ğŸ³ Instalando Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # ========================================
          # 3. CONFIGURAÃ‡ÃƒO DO FIREWALL
          # ========================================
          
          echo "ğŸ”¥ Configurando firewall..."
          sudo ufw --force enable
          sudo ufw allow ssh
          sudo ufw allow 80/tcp
          sudo ufw allow 443/tcp
          sudo ufw allow 5432/tcp
          sudo ufw allow 6379/tcp
          sudo ufw --force reload
          
          # ========================================
          # 4. BACKUP DO BANCO DE DADOS (se existir)
          # ========================================
          
          echo "ğŸ’¾ Fazendo backup do banco de dados..."
          mkdir -p backups
          if docker ps | grep -q "digiurban_db"; then
            echo "ğŸ“Š Banco de dados encontrado. Fazendo backup..."
            docker exec digiurban_db pg_dump -U digiurban digiurban_db > backups/backup_$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || echo "âš ï¸  Erro no backup, continuando..."
          else
            echo "â„¹ï¸  Nenhum banco de dados encontrado para backup."
          fi
          
          # ========================================
          # 5. DOWNLOAD DO CÃ“DIGO DA APLICAÃ‡ÃƒO
          # ========================================
          
          echo "â¬‡ï¸  Baixando cÃ³digo da aplicaÃ§Ã£o..."
          if [ -d ".git" ]; then
            echo "ğŸ“¡ Atualizando repositÃ³rio existente..."
            git fetch origin
            git reset --hard origin/main
          else
            echo "ğŸ“¡ Clonando repositÃ³rio pela primeira vez..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # ========================================
          # 6. CONFIGURAÃ‡ÃƒO DE ARQUIVOS DE AMBIENTE
          # ========================================
          
          echo "âš™ï¸  Configurando arquivos de ambiente..."
          
          # Criar arquivo .env.production com as secrets
          cat > .env.production << EOF
          # ConfiguraÃ§Ã£o do Banco de Dados
          DB_HOST=digiurban_db
          DB_PORT=5432
          DB_NAME=digiurban_db
          DB_USER=digiurban
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # ConfiguraÃ§Ã£o da AplicaÃ§Ã£o
          NODE_ENV=production
          PORT=3000
          
          # ConfiguraÃ§Ã£o de CORS
          CORS_ORIGIN=https://www.digiurban.com.br,https://digiurban.com.br
          
          # ConfiguraÃ§Ã£o de JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=24h
          
          # ConfiguraÃ§Ã£o do Redis
          REDIS_HOST=digiurban_redis
          REDIS_PORT=6379
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # ConfiguraÃ§Ã£o de Email (se fornecido)
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          
          # ConfiguraÃ§Ã£o SSL
          SSL_CERT_PATH=/etc/letsencrypt/live/www.digiurban.com.br/fullchain.pem
          SSL_KEY_PATH=/etc/letsencrypt/live/www.digiurban.com.br/privkey.pem
          
          # ConfiguraÃ§Ã£o de Logs
          LOG_LEVEL=info
          LOG_FILE=/var/log/digiurban/app.log
          EOF
          
          # Criar diretÃ³rio de logs
          sudo mkdir -p /var/log/digiurban
          sudo chown -R digiurban:digiurban /var/log/digiurban
          
          # ========================================
          # 7. CONFIGURAÃ‡ÃƒO DO NGINX
          # ========================================
          
          echo "ğŸŒ Configurando Nginx..."
          sudo mkdir -p /etc/nginx/sites-available
          sudo mkdir -p /etc/nginx/sites-enabled
          
          # Copiar configuraÃ§Ã£o do Nginx
          sudo cp nginx/nginx.conf /etc/nginx/nginx.conf
          sudo cp nginx/conf.d/digiurban.conf /etc/nginx/sites-available/digiurban.conf
          
          # Habilitar site
          sudo ln -sf /etc/nginx/sites-available/digiurban.conf /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Testar configuraÃ§Ã£o do Nginx
          sudo nginx -t
          
          # ========================================
          # 8. CONFIGURAÃ‡ÃƒO DO SSL/TLS
          # ========================================
          
          echo "ğŸ”’ Configurando SSL/TLS..."
          
          # Parar Nginx temporariamente para o Certbot
          sudo systemctl stop nginx
          
          # Obter certificado SSL (se ainda nÃ£o existir)
          if [ ! -f "/etc/letsencrypt/live/www.digiurban.com.br/fullchain.pem" ]; then
            echo "ğŸ” Obtendo certificado SSL..."
            sudo certbot certonly --standalone -d www.digiurban.com.br -d digiurban.com.br --non-interactive --agree-tos --email contato@digiurban.com.br
          else
            echo "âœ… Certificado SSL jÃ¡ existe."
          fi
          
          # Iniciar Nginx
          sudo systemctl start nginx
          sudo systemctl enable nginx
          
          # ========================================
          # 9. DOWNLOAD DA IMAGEM DOCKER
          # ========================================
          
          echo "ğŸ³ Fazendo login no GitHub Container Registry..."
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "ğŸ“¦ Baixando imagem Docker..."
          docker pull ghcr.io/${{ github.repository }}:latest
          
          # ========================================
          # 10. PARAR CONTAINERS ANTIGOS
          # ========================================
          
          echo "â¹ï¸  Parando containers antigos..."
          docker-compose down 2>/dev/null || echo "â„¹ï¸  Nenhum container rodando."
          
          # ========================================
          # 11. CONFIGURAÃ‡ÃƒO DO BANCO DE DADOS
          # ========================================
          
          echo "ğŸ—„ï¸  Configurando banco de dados..."
          
          # Subir apenas o banco de dados primeiro
          docker-compose up -d digiurban_db
          
          # Aguardar banco ficar pronto
          echo "â³ Aguardando banco de dados ficar pronto..."
          for i in {1..60}; do
            if docker exec digiurban_db pg_isready -U digiurban; then
              echo "âœ… Banco de dados pronto!"
              break
            fi
            sleep 2
          done
          
          # Criar banco de dados se nÃ£o existir
          docker exec digiurban_db psql -U digiurban -c "CREATE DATABASE digiurban_db;" 2>/dev/null || echo "â„¹ï¸  Banco de dados jÃ¡ existe."
          
          # ========================================
          # 12. SUBIR TODOS OS CONTAINERS
          # ========================================
          
          echo "ğŸš€ Subindo todos os containers..."
          docker-compose up -d
          
          # ========================================
          # 13. EXECUTAR MIGRATIONS E SEEDERS
          # ========================================
          
          echo "â³ Aguardando aplicaÃ§Ã£o ficar pronta..."
          sleep 30
          
          echo "ğŸ”„ Executando migrations..."
          docker exec digiurban_app npm run migrate 2>/dev/null || echo "â„¹ï¸  Nenhuma migration para executar."
          
          echo "ğŸŒ± Executando seeders..."
          docker exec digiurban_app npm run seed 2>/dev/null || echo "â„¹ï¸  Nenhum seeder para executar."
          
          # ========================================
          # 14. CONFIGURAR RENOVAÃ‡ÃƒO AUTOMÃTICA SSL
          # ========================================
          
          echo "ğŸ”„ Configurando renovaÃ§Ã£o automÃ¡tica do SSL..."
          (sudo crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | sudo crontab -
          
          # ========================================
          # 15. CONFIGURAR BACKUP AUTOMÃTICO
          # ========================================
          
          echo "ğŸ’¾ Configurando backup automÃ¡tico..."
          (sudo crontab -l 2>/dev/null; echo "0 2 * * * cd /var/www/digiurban && docker exec digiurban_db pg_dump -U digiurban digiurban_db > backups/backup_\$(date +\%Y\%m\%d_\%H\%M\%S).sql") | sudo crontab -
          
          # ========================================
          # 16. LIMPEZA E OTIMIZAÃ‡ÃƒO
          # ========================================
          
          echo "ğŸ§¹ Limpeza e otimizaÃ§Ã£o..."
          docker system prune -f
          docker image prune -f
          
          # Remover backups antigos (manter apenas Ãºltimos 7 dias)
          find backups/ -name "backup_*.sql" -mtime +7 -delete 2>/dev/null || true
          
          # ========================================
          # 17. VERIFICAÃ‡ÃƒO FINAL
          # ========================================
          
          echo "ğŸ” VerificaÃ§Ã£o final dos containers..."
          docker-compose ps
          
          echo "âœ… Deploy concluÃ­do com sucesso!"
          echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: https://www.digiurban.com.br"
          
          # Mostrar status dos serviÃ§os
          echo "ğŸ“Š Status dos serviÃ§os:"
          docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
          
    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          ğŸš€ Deploy do DigiUrban ${{ job.status }}!
          
          ğŸ“‹ Detalhes:
          â€¢ Branch: ${{ github.ref }}
          â€¢ Commit: ${{ github.sha }}
          â€¢ Autor: ${{ github.actor }}
          â€¢ DomÃ­nio: https://www.digiurban.com.br
          
          ${{ job.status == 'success' && 'âœ… AplicaÃ§Ã£o online e funcionando!' || 'âŒ Falha no deploy - verifique os logs!' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        
  # Job de verificaÃ§Ã£o completa de saÃºde
  health-check:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Wait for deployment
      run: |
        echo "â³ Aguardando 60 segundos para aplicaÃ§Ã£o estabilizar..."
        sleep 60
      
    - name: Comprehensive Health Check
      run: |
        echo "ğŸ” Executando verificaÃ§Ã£o completa de saÃºde..."
        
        # Verificar se o domÃ­nio estÃ¡ respondendo
        echo "ğŸŒ Verificando domÃ­nio principal..."
        if curl -f -k https://www.digiurban.com.br --max-time 30; then
          echo "âœ… DomÃ­nio principal respondendo!"
        else
          echo "âŒ DomÃ­nio principal nÃ£o estÃ¡ respondendo!"
          exit 1
        fi
        
        # Verificar redirecionamento HTTP para HTTPS
        echo "ğŸ”’ Verificando redirecionamento HTTPS..."
        if curl -I http://www.digiurban.com.br --max-time 30 | grep -q "301\|302"; then
          echo "âœ… Redirecionamento HTTPS funcionando!"
        else
          echo "âš ï¸  Redirecionamento HTTPS pode nÃ£o estar funcionando."
        fi
        
        # Verificar API de saÃºde (se existir)
        echo "ğŸ©º Verificando API de saÃºde..."
        if curl -f -k https://www.digiurban.com.br/api/health --max-time 30; then
          echo "âœ… API de saÃºde respondendo!"
        else
          echo "â„¹ï¸  API de saÃºde nÃ£o encontrada (normal se nÃ£o implementada)."
        fi
        
        # Verificar certificado SSL
        echo "ğŸ” Verificando certificado SSL..."
        if echo | openssl s_client -connect www.digiurban.com.br:443 -servername www.digiurban.com.br 2>/dev/null | grep -q "Verify return code: 0"; then
          echo "âœ… Certificado SSL vÃ¡lido!"
        else
          echo "âš ï¸  Certificado SSL pode ter problemas."
        fi
        
        echo "ğŸ‰ VerificaÃ§Ã£o de saÃºde concluÃ­da com sucesso!"
        
    - name: Rollback on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          set -e
          
          echo "ğŸ”„ Iniciando rollback automÃ¡tico..."
          
          cd /var/www/digiurban
          
          # Reverter para commit anterior
          git reset --hard HEAD~1
          
          # Fazer rollback dos containers
          docker-compose down
          docker-compose up -d
          
          # Aguardar containers ficarem prontos
          sleep 30
          
          # Verificar se rollback funcionou
          if curl -f -k https://www.digiurban.com.br --max-time 30; then
            echo "âœ… Rollback realizado com sucesso!"
          else
            echo "âŒ Rollback falhou - intervenÃ§Ã£o manual necessÃ¡ria!"
          fi
          
    - name: Final Status Report
      if: always()
      run: |
        echo "ğŸ“Š ======================================"
        echo "ğŸ“Š RELATÃ“RIO FINAL DO DEPLOY"
        echo "ğŸ“Š ======================================"
        echo "ğŸŒ DomÃ­nio: https://www.digiurban.com.br"
        echo "ğŸ“… Data: $(date)"
        echo "ğŸ”§ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"
        echo "ğŸ¯ Status: ${{ job.status }}"
        echo "ğŸ“Š ======================================" 